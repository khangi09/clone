version: 2.1 # Note: Orbs require version 2.1

# 1️⃣ Define the Orb
orbs:
  sonarcloud: sonarsource/sonarcloud@3.0.1 # Always check for the latest version

jobs:
  build:
    docker:
      # Use a standard Docker image for your application build
      - image: cimg/node:22.15
    working_directory: ~/repo
    steps:
      # 1️⃣ Checkout your code
      - checkout

      # 2️⃣ Install Node dependencies
      - run:
          name: Install dependencies
          command: npm ci

      # 3️⃣ Run unit tests (skip if none)
      # Ensure your tests generate a report (e.g., using Jest with coverage reporter)
      - run:
          name: Run tests
          command: npm test || echo "No tests found"

      # 4️⃣ Run SonarCloud analysis using the Orb
      # This step replaces your old 'Setup SonarScanner CLI' and 'Run SonarCloud analysis' steps.
      - sonarcloud/scan:
          # These parameters correspond to the ones you had in your original command:
          project_key: backend 
          organization: khangi09 # Your SonarCloud organization
          # sonar_token_variable_name defaults to SONAR_TOKEN, which is recommended.
          # Host URL defaults to https://sonarcloud.io, so you don't need to specify it.
          # Note: Ensure SONAR_TOKEN is set as a secure Environment Variable in your CircleCI project.

workflows:
  version: 2
  build_and_scan:
    jobs:
      - build